const mysql = require('mysql2/promise');
require('dotenv').config();

const pool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD || '', // á”á¾á€áŸ’á“á»á„ .env á‘á‘áŸ áœá¶á“á¹á„á™á€ string á‘á‘áŸ
  database: process.env.DB_NAME,
  port: process.env.DB_PORT || 3306,
  waitForConnections: true,
  connectionLimit: 10
});

const initDb = async () => {
  try {
    const connection = await pool.getConnection();
    console.log("ğŸš€ á€áŸ†á–á»á„áá—áŸ’á‡á¶á”áŸ‹á‘áŸ…á€á¶á“áŸ‹ MySQL...");
    
    await connection.query(`
      CREATE TABLE IF NOT EXISTS students (
        id INT AUTO_INCREMENT PRIMARY KEY,
        fullname VARCHAR(255),
        phone VARCHAR(50),
        course VARCHAR(100),
        registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    `);
    await connection.query(`
  CREATE TABLE IF NOT EXISTS majors (
    id INT AUTO_INCREMENT PRIMARY KEY,
    major_name VARCHAR(100) UNIQUE
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
`);
    // á”á“áŸ’ááŸ‚á˜á€áŸ’á“á»á„ initDb function

    connection.release();
    console.log("âœ… áá—áŸ’á‡á¶á”áŸ‹á‡áŸ„á‚á‡áŸá™ á“á·á„á˜á¶á“ Table ášá½á…ášá¶á›áŸ‹!");
  } catch (err) {
    console.error("âŒ áá¼á…á€á¶ášá á¾á™á˜áŸ! áá—áŸ’á‡á¶á”áŸ‹ Database á¢ááŸ‹á”á¶á“á‘áŸáŸ–", err.message);
  }
};



module.exports = { pool, initDb };