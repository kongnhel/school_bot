<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NMU Admin Pro</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="header">
        <h1>NMU Admin Panel</h1>
        <p>គ្រប់គ្រងទិន្នន័យសាលារបស់អ្នកដោយទំនុកចិត្ត</p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('majors', this)">
            <i class="fas fa-graduation-cap"></i> ជំនាញ
        </div>
        <div class="tab" onclick="switchTab('students', this)">
            <i class="fas fa-users"></i> បញ្ជីសិស្ស
        </div>
    </div>

    <div id="majors-section" class="content-section active">
        <div id="major-list">
            <% majors.forEach(major => { %>
                <div class="card">
                    <div class="info">
                        <span class="badge">ID: <%= major._id %></span>
                        <span class="title-text"><%= major.major_name %></span>
                    </div>
                    <div class="action-group">
                        <button class="btn-icon btn-edit" onclick="openEditModal('<%= major._id %>', '<%= major.major_name %>')">
                            <i class="fas fa-pen"></i>
                        </button>
                        <a href="/admin/majors/delete/<%= major._id %>" 
                           class="btn-icon btn-delete" 
                           onclick="return confirm('តើអ្នកពិតជាចង់លុបជំនាញនេះមែនទេ?')">
                            <i class="far fa-trash-alt"></i>
                        </a>
                    </div>
                </div>
            <% }) %>
        </div>
        
        <button class="fab-add" onclick="openAddModal()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div id="students-section" class="content-section">
        <div class="table-controls">
            <input type="text" id="searchInput" onkeyup="searchStudent()" placeholder="ស្វែងរកឈ្មោះសិស្ស...">
            <button class="btn-export" onclick="exportToCSV()">
                <i class="fas fa-file-export"></i> ទាញយកជា CSV
            </button>
        </div>

        <div class="table-container">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>លេខសម្គាល់</th>
                        <th>ឈ្មោះពេញ</th>
                        <th>លេខទូរស័ព្ទ</th>
                        <th>ជំនាញ</th>
                        <th style="text-align: center;">សកម្មភាព</th>
                    </tr>
                </thead>
                <tbody id="student-list-body">
    <% students.forEach(student => { %>
        <tr class="student-item">
            <td><span class="badge">ID: <%= student.student_id || student.id || 'N/A' %></span></td>
            
            <td class="student-name"><%= student.fullname || student.name || 'គ្មានឈ្មោះ' %></td>
            
            <td class="student-phone"><%= student.phone || 'គ្មានលេខ' %></td>
            <td class="student-course"><%= student.course || student.major || 'មិនទាន់រើស' %></td>
            <td style="text-align: center;">
                <div class="action-group">
                    <a href="/admin/students/delete/<%= student._id %>" 
                       class="btn-icon btn-delete" 
                       onclick="return confirm('តើអ្នកពិតជាចង់លុបសិស្សនេះមែនទេ?')">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </td>
        </tr>
    <% }) %>
</tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        <p>NMU School Management System </p>
    </div>

    <div id="majorModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle"><i class="fas fa-plus-circle"></i> បន្ថែមជំនាញថ្មី</h3>
            <form id="majorForm" action="/admin/majors/add" method="POST">
                <input type="text" name="major_name" id="major_name_input" class="modal-input" placeholder="បញ្ចូលឈ្មោះជំនាញ..." required>
                <div class="modal-footer">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">បោះបង់</button>
                    <button type="submit" class="btn-modal btn-save">រក្សាទុក</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.setHeaderColor('#f8fafc');

        function switchTab(type, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(type + '-section').classList.add('active');
            el.classList.add('active');
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        // --- Major Functions ---
        function openAddModal() {
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> បន្ថែមជំនាញថ្មី';
            document.getElementById('majorForm').action = '/admin/majors/add';
            document.getElementById('major_name_input').value = '';
            document.getElementById('majorModal').style.display = 'flex';
        }

        function openEditModal(id, name) {
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> កែសម្រួលជំនាញ';
            document.getElementById('majorForm').action = '/admin/majors/update/' + id;
            document.getElementById('major_name_input').value = name;
            document.getElementById('majorModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('majorModal').style.display = 'none';
        }

        window.onclick = (e) => { if(e.target.id === 'majorModal') closeModal(); }

        // --- Student Functions (Updated for Table) ---
        function searchStudent() {
            let input = document.getElementById('searchInput').value.toLowerCase();
            let rows = document.querySelectorAll('#student-list-body tr');
            
            rows.forEach(row => {
                let name = row.querySelector('.student-name').innerText.toLowerCase();
                row.style.display = name.includes(input) ? "" : "none";
            });
        }

        function exportToCSV() {
            let csv = "\ufeffលេខសម្គាល់,ឈ្មោះពេញ,លេខទូរស័ព្ទ,ជំនាញ\n";
            let rows = document.querySelectorAll('#student-list-body tr');
            
            rows.forEach(row => {
                if(row.style.display !== 'none') {
                    let id = row.querySelector('.badge').innerText.replace('Student ID: ', '');
                    let name = row.querySelector('.student-name').innerText;
                    let phone = row.querySelector('.student-phone').innerText;
                    let course = row.querySelector('.student-course').innerText;
                    csv += `${id},"${name}","${phone}","${course}"\n`;
                }
            });
            
            let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Students_Export_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }
    </script>
</body>
</html>